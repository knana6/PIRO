#ragapp/templates/ragapp/index.html

<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>문서기반 RAG 챗봇</title>
<style>
  :root { --bg:#fafafa; --card:#fff; --line:#e6e6e6; --text:#111; --muted:#666; --accent:#4f8cff; }
  * { box-sizing: border-box; }
  body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; }
  header { position:sticky; top:0; background:var(--card); border-bottom:1px solid var(--line); padding:14px 16px; z-index:10; }
  header h1 { margin:0; font-size:18px; }
  .container { max-width:920px; margin:0 auto; padding: 16px; }
  #chat { display:flex; flex-direction:column; gap:12px; padding-bottom:100px; }
  .msg { display:flex; gap:10px; align-items:flex-end; }
  .msg .bubble { max-width:78%; padding:12px 14px; border:1px solid var(--line); border-radius:14px; background:var(--card); line-height:1.5; }
  .msg.user { justify-content:flex-end; }
  .msg.user .bubble { background:#eef3ff; border-color:#d6e3ff; }
  .msg.bot .bubble { background:#f3fbf4; border-color:#dcefe0; }
  .meta { font-size:12px; color:var(--muted); margin-top:6px; }
  .sources { margin-top:8px; border-top:1px dashed var(--line); padding-top:8px; font-size:13px; color:#2b2b2b; }
  .sources summary { cursor:pointer; }
  .composer { position:fixed; left:0; right:0; bottom:0; background:linear-gradient(180deg, rgba(250,250,250,0), var(--bg) 20%, var(--bg) 100%); }
  .composer .wrap { max-width:920px; margin:0 auto; padding:12px 16px 16px; display:flex; gap:8px; }
  textarea { flex:1; resize:vertical; min-height:48px; max-height:180px; padding:12px 14px; border-radius:12px; border:1px solid var(--line); outline:none; }
  button { padding:12px 16px; border-radius:12px; border:1px solid var(--line); background:#fff; cursor:pointer; }
  button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
  button[disabled] { opacity:.6; cursor:not-allowed; }
  .spinner { width:18px; height:18px; border:2px solid #0000; border-top-color:#999; border-left-color:#999; border-radius:50%; animation:spin 0.8s linear infinite; display:inline-block; vertical-align:-3px; }
  @keyframes spin { to { transform: rotate(360deg); } }
  code.inline { background:#f0f0f0; padding:0 4px; border-radius:6px; }
</style>

</head>
<body>
  <header><h1>문서기반 RAG 챗봇</h1></header>
  <div class="container">
    <div id="chat"></div>
  </div>

  <div class="composer">
    <div class="wrap">
      <textarea id="q" placeholder="질문을 입력하세요 (Shift+Enter 줄바꿈, Enter 전송)"></textarea>
      <button id="send" class="primary">질문</button>
    </div>
  </div>

<!--자바 스크립트 코드 설명해주기 --!>
<script>
const chat = document.getElementById('chat');
const q = document.getElementById('q');
const sendBtn = document.getElementById('send');

let sending = false;

function nowTime(){
  const d = new Date();
  const hh = String(d.getHours()).padStart(2,'0');
  const mm = String(d.getMinutes()).padStart(2,'0');
  return `${hh}:${mm}`;
}

function escapeHTML(s){
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function addMessage(role, text, sources){
  const row = document.createElement('div');
  row.className = `msg ${role}`;

  const bubble = document.createElement('div');
  bubble.className = 'bubble';

  const html = escapeHTML(text).replace(/\n/g,'<br>');
  bubble.innerHTML = html;

  // sources (optional)
  if (sources && sources.length){
    const details = document.createElement('details');
    details.className = 'sources';
    const summary = document.createElement('summary');
    summary.textContent = `참고 출처 (${sources.length})`;
    details.appendChild(summary);

    const ul = document.createElement('ul');
    ul.style.margin = '6px 0 0 18px';
    sources.forEach(s => {
      const li = document.createElement('li');
      const pg = s.page != null ? `p.${s.page}` : 'p.?';
      li.innerHTML = `<code class="inline">${escapeHTML(pg)}</code> – ${escapeHTML(s.preview || '')}`;
      ul.appendChild(li);
    });
    details.appendChild(ul);
    bubble.appendChild(details);
  }

  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.textContent = `${role === 'user' ? '나' : '조교'} · ${nowTime()}`;

  row.appendChild(bubble);
  row.appendChild(meta);
  chat.appendChild(row);
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}

function addThinking(){
  const row = document.createElement('div');
  row.className = 'msg bot';
  row.id = 'thinking';
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.innerHTML = `<span class="spinner"></span> 조교가 생각 중...`;
  row.appendChild(bubble);
  chat.appendChild(row);
  window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}

function removeThinking(){
  const th = document.getElementById('thinking');
  if (th) th.remove();
}

async function ask(question){
  sending = true;
  sendBtn.disabled = true;
  addMessage('user', question);
  addThinking();
  try{
    const res = await fetch('/api/ask', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({question})
    });
    const data = await res.json();
    removeThinking();
    if (!res.ok) {
      addMessage('bot', `에러: ${data?.error || res.statusText}`);
      return;
    }
    addMessage('bot', data.answer || '(응답 없음)', data.sources || []);
  }catch(err){
    removeThinking();
    addMessage('bot', '네트워크 오류가 발생했어요. 서버가 켜져있는지 확인해주세요.');
  }finally{
    sending = false;
    sendBtn.disabled = false;
  }
}

sendBtn.addEventListener('click', () => {
  const question = q.value.trim();
  if (!question || sending) return;
  q.value = '';
  ask(question);
});

q.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendBtn.click();
  }
});
</script>
</body>
</html>